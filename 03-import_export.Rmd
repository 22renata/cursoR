# Importando e exportando dados em R

## data-frames

Probabelmente um dos promeiros objetos que vamos usar quando começamos usar R.
Pensa num data-frame como uma planilha de Libreoffice (o excel). Os data-frame
pode ser criaos como foi visto na seção anterior. O principal, é que temos varias
funções para ler data-frames no R, entre elas

- read.csv
- read.csv2
- read.table

Agora vamos a ler dados do repositorio usando read.table, mas primeiro vamos lembrar
que se tu precisar ver a ajuda da função, tem que escrever no R `?read.table`.
Então, agora vamos ver os argumentos da função:

```{r}
args(read.table)
```

Aqui vem-se os valores default dos argumentos da função `read.table`. O terceiro
argumento é sep, com valores por default = "". 


```{r}
df <- read.table("https://raw.githubusercontent.com/ibarraespinosa/cursoR/master/dados/NOXIPEN2014.txt")
```

Agora vamos usar a funções `head` and `tail` para ver as primeiras e as ultimas
6 linhas do data-frame.

```{r}
head(df)
tail(df)
```


Agora vamos ler os mesmos dados com outro formato e testar e read.table funciona
do mesmo jeito
```{r eval = FALSE}
df2 <- read.table("https://raw.githubusercontent.com/ibarraespinosa/cursoR/master/dados/NOXIPEN2014v2.txt")
# Error in scan(file = file, what = what, sep = sep, quote = quote, dec = dec, : 
# linha 1 não tinha 6 elementos
```

Vemos a mensagem de error, mas o que quer dizer.

**Se tu recever um banco de dados tipo .txt e quer abrir no R... ABRE ELE COM BLOCO DE NOTAS PRIMEIRO!!!**

O primeiro arquivo:

```{r echo = FALSE}
knitr::include_graphics("figuras/f1.png")
```

O segundo arquivo é:

```{r echo = FALSE}
knitr::include_graphics("figuras/f2.png")
```


qual é a diferença?


Como vemos o segundo arquivo tem separação de ";", entao, temos que lero arquivo
assim:

```{r}
df2 <- read.table("https://raw.githubusercontent.com/ibarraespinosa/cursoR/master/dados/NOXIPEN2014v2.txt", sep = ";")
head(df2)
tail(df2)
```


### Qua dificultades tu já enfrentou importando dados?



## Processando nossa data-frame

Tem numeroas formas e pacotes para ordenar, arrangiar (Arrange), mutar e cambiar
as data-frames. As mais conhecidas são provablemente do universe *tidyverse* com 
o famoso pacote _dplyr_. Mas, nesta curso vamos focar em **base**.

Vamos então revisar a classe de cada columna do nosso data-frame com a função
`sapply`, apresentada em outro capitulo, mas se quiser, da uma olhada em `?sapply`.

```{r}
sapply(df, class)
```

Quando nos trabalhamos com series de tempo, é importante ter a variabel de tempo
reconhecida como "tempo", especificamente como classe "POSIXct". Mas, a classe de
Data é "factor" e de Hora tambem "factor", o que é ruim. Então, vamos criar uma
variabel de tempo mais standard com formato `r Sys.time()`.

Para isso temos que grudar as variabel Data e Hora. Faremios isso numa nova
varaibel chamada tempo_char, adicionando ela diretamente no `df` com o cifrão 
DOLLAR $. O grude pode ser feito com as funções `paste` ou `paste0`.

```{r}
df$tempo_char <- paste(df$Data, df$Hora)
head(df$tempo_char)
class(df$tempo_char)
```

Esta melhorando mas ainda tem clase `r class(df$tempo_char)`.

Para convertir a nossa classe POSIXct podemos usar a função `as.POSIXct` (olha 
`as.POSIXct`). Seus argumentos são:

```{r}
args(as.POSIXct)
```


Então, vamos criar outra variabel tempo o formato POSIXct

```{r}
df$tempo <- as.POSIXct(x = df$tempo_char, tz = "Americas/Sao_Paulo", 
                       format = "%d/%m/%Y %H:%M")
head(df$tempo)
class(df$tempo)
```

Agora, vamos a extraer os dias da semana do tempo, mes e dia juliano:

```{r}
df$weekdays <- weekdays(df$tempo)
head(df$weekdays)
df$mes <- months(df$tempo)
head(df$mes)
df$diajuliano <- julian(df$tempo)
head(df$diajuliano)
```

## aggregate


## subset

## data.table, read_xl e mais

data.table é um pacote que apresenta a classe `data.table`, que é como uma versão
melhorada da classe `data-frame` O termo especifico é que `data-table` tem 
herencia (inherits) da classe `data.frame`

Vamos ver como funciona data.table lendo o dois arquivos e comparar quanto tempo
demoram cada um.

```{r}
df1 <- print(system.time(read.table("https://raw.githubusercontent.com/ibarraespinosa/cursoR/master/dados/NOXIPEN2014.txt", h = T)))
```

```{r}
library(data.table)
df2 <- print(system.time(fread("https://raw.githubusercontent.com/ibarraespinosa/cursoR/master/dados/NOXIPEN2014.txt", h = T)))

```



olha que estamos usando a função `fread`.

read_xl é mais uma função do universo tidyverse que permite importar excel no R,
diretamente e inteligentemente.

## NetCDF

O NetCDF (Network Common Data Form) é um conjunto de bibliotecas de software e formatos de dados independentes de máquina e autodescritivos com suporte para criação, acesso e compartilhamento de dados científicos orientados a matrizes. Arquivos NetCDF (criado por essa biblioteca ou por programas que utilizam essa biblioteca) são arquivos com dados, atributos e metadados.

O pacote `ncdf4` podes ser usado com o R para ler e escrever estes arquivos, os comandos abaixo instalam e carregam o pacote:
```{r eval = FALSE}
install.packages("ncdf4")
nc_version() # que retorna a versão da biblioteca que o R está utilizando
```
Um arquivo então pode ser ascessado por:
```{r}
library("ncdf4")
download.file("https://github.com/ibarraespinosa/cursoR/raw/master/dados/met_em.d03.2016-01-10.nc", destfile = "~/met_em.d03.2016-01-10.nc")
wrf <- nc_open("dados/met_em.d03.2016-01-10.nc")
```
A partir de agora o objeto wrf, contem algumas informações sobre o arquivo, por exemplo um `print(wrf)` ou simplesmente `wrf` mostra o conteúdo do arquivo:
```{r}
wrf
```
Entre a informação mostrada na tela estão o nome do arquivo (e versão da biblioteca usada para criar), numero de variáveis (92 no arquivo de exemplo), uma descrição de cada variavel (incluindo atributos) as dimenções (13 para esse aquivo) e os atributos globais.

Agora vamos abrir alguma variável:
```{r}
names(wrf$var)              # print no nome de cada variavel
ST <- ncvar_get(wrf, "ST")  # escolho você picachu

```
ncvar_get	Read data from a netCDF file


ncatt_get	Get attribute from netCDF file
ncatt_put	Put an attribute into a netCDF file

ncvar_add	Add New netCDF Variable to Existing File
ncvar_change_missval	Change the Missing Value For a netCDF Variable
ncvar_def	Define a netCDF Variable
ncvar_put	Write data to a netCDF file
ncvar_rename	Rename an Existing Variable in a netCDF File

nc_version	Report version of ncdf4 library
nc_create	Create a netCDF File
ncdim_def	Define a netCDF Dimension
nc_enddef	Takes a netCDF file out of define mode
nc_redef	Puts a netCDF file back into define mode

nc_close	Close a netCDF File
nc_sync	Synchronize (flush to disk) a netCDF File


Para salvar toda informação e liberar o ascesso ao arquivo use a função `nc_close` (ou a função `nc_sync` que sincroniza o NetCDF carregado na memória com o NetCDF no Disco)
```{r}
nc_close(wrf)
```



## Binarios

